!function(t){var e={};function s(i){if(e[i])return e[i].exports;var r=e[i]={i:i,l:!1,exports:{}};return t[i].call(r.exports,r,r.exports,s),r.l=!0,r.exports}s.m=t,s.c=e,s.d=function(t,e,i){s.o(t,e)||Object.defineProperty(t,e,{configurable:!1,enumerable:!0,get:i})},s.r=function(t){Object.defineProperty(t,"__esModule",{value:!0})},s.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return s.d(e,"a",e),e},s.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},s.p="",s(s.s=0)}([function(t,e,s){"use strict";s.r(e);class i{constructor(t,e,s){[t.width,t.height]=[e,s],[this.width,this.height]=[e,s];const i=t.getContext("2d");i.lineWidth=2,i.font="20px OCR-A",this.ctx=i}}const r=new(window.AudioContext||window.webkitAudioContext),n=document.querySelector(".video-instance"),a=document.querySelector(".scene"),h=document.querySelector(".interface"),o=document.querySelector(".container"),c=document.querySelector(".mute-speech");let[d,l]=[770,650];window.innerWidth<770&&([d,l]=[window.innerWidth,window.innerHeight]);const u=new class{constructor(t){this.tts=t}setWords(t){this.words=t}getRandomWord(){return this.words[Math.floor(Math.random()*this.words.length-1)]}speak(){this.tts.speak(this.getRandomWord())}speakWord(t){this.tts.speak(t)}}(new window.ya.speechkit.Tts({apikey:"6645e72c-462b-462f-923e-eda53f70819a",emotion:"bad",speed:1.2,lang:"ru-RU",speaker:"omazh"}));u.setWords(["Замечено движение!","Цель в поле зрения","Убить всех людей!","Вижу движение","Зафиксировала изменение обстановки","От меня не укрыться!"]),u.speakWord("Фиксирую месторасположения - офис Yandex!");const g=new class extends i{constructor(t,e,s,i,r,n,a,h){super(s,i,r),this.constraints={audio:!0,video:{width:i,height:r}},this.video=t,this.audioCtx=e,this.detected=!1,this.detectingInProcess=!1,this.speaker=n,this.containerElement=a,this.muteSpeech=!0,this.muteButton=h,this.rgb={r:0,g:0,b:0},this.oldRgb={r:0,g:0,b:0}}load(){const{audioCtx:t}=this,e=t.createAnalyser();e.minDecibels=-80,e.maxDecibels=-8,e.smoothingTimeConstant=.7,e.fftSize=2048,this.analyser=e,navigator.mediaDevices.getUserMedia(this.constraints).then(s=>{this.video.srcObject=s,t.createMediaStreamSource(s).connect(e),this.animate()})}getAnalyser(){return this.analyser}toggleMuteSpeech(){this.muteSpeech?(this.muteSpeech=!1,this.muteButton.innerHTML="TURN OFF SYNHTHSPEECH"):(this.muteSpeech=!0,this.muteButton.innerHTML="TURN ON SYNHTHSPEECH")}detectMove(){const{detectingInProcess:t,oldRgb:e,rgb:s}=this;t||(Math.abs(e.r-s.r)+Math.abs(e.g-s.g)+Math.abs(e.b-s.b)>7?(this.muteSpeech||this.speaker.speak(),this.containerElement.classList.add("red"),this.setDetected(!0),this.setDetectedInProcess(!0),setTimeout(()=>{this.containerElement.classList.remove("red"),this.setDetectedInProcess(!1),this.setOldRGB(s)},2500)):this.setDetected(!1))}setDetected(t){this.detected=t}getDetected(){return this.detected}setDetectedInProcess(t){this.detectingInProcess=t}setRGB(t){this.rgb=t}setOldRGB(t){this.oldRgb=t}getRGB(){return this.rgb}drawVideo(){this.ctx.drawImage(this.video,0,0,this.width,this.height)}drawNoiseAndComputeAvarageColor(){const t=this.ctx.getImageData(0,0,this.width,this.height),e={r:0,g:0,b:0},{data:s}=t,{length:i}=s;let r=0,n=0,a=0;for(;r<i;)a+=1,e.r+=s[r],e.g+=s[r+1],e.b+=s[r+2],n=.5-Math.random(),s[r]+=255*n,s[r+1]+=255*n,s[r+2]+=255*n,r+=60;this.ctx.putImageData(t,0,0),e.r=Math.round(e.r/a),e.g=Math.round(e.g/a),e.b=Math.round(e.b/a),this.setRGB(e)}animate(){this.drawVideo(),this.drawNoiseAndComputeAvarageColor(),requestAnimationFrame(this.animate.bind(this))}}(n,r,a,d,l,u,o,c);g.load(),new class extends i{constructor(t,e,s){super(t,e,s),this.bufferLength=2048}connectScene(t){return new Promise(e=>{this.scene=t;const s=t.getAnalyser();s.fftSize=2048;const i=s.fftSize,r=new Uint8Array(i);[this.analyser,this.bufferLength,this.dataArray]=[s,i,r],e(this)})}valToHex(t){const e=t.toString(16);return 1===e.length?`0${e}`:e}rgbToHex(t,e,s){return`#${this.valToHex(t)}${this.valToHex(e)}${this.valToHex(s)}`}drawDetected(){this.ctx.fillStyle="#00ffff",this.ctx.fillText("MOVEMENT_DETECTED",10,125)}clearCanvas(){this.ctx.clearRect(0,0,this.width,this.height)}setFillStyle(t){this.ctx.fillStyle=t}setStrokeStyle(t){this.ctx.strokeStyle=t}drawHistogramm(){this.setFillStyle("rgb(200, 200, 200)"),this.setStrokeStyle("rgb(204, 255, 255)"),this.analyser.getByteTimeDomainData(this.dataArray),this.ctx.beginPath();const t=320/this.bufferLength;let e=10,s=0;for(let i=0;i<this.bufferLength;i+=1){const r=this.dataArray[i]/128*60;s+=Math.abs(this.dataArray[i]-128);const n=180+r;0===i?this.ctx.moveTo(e,n):this.ctx.lineTo(e,n),e+=t}this.ctx.stroke(),this.drawAverageVolume(s)}drawAverageVolume(t){const e=t/this.bufferLength*15+20,s=Math.min(Math.round(e/5),75);for(let t=0;t<=s;t+=1)this.setFillStyle(`rgb(${Math.min(5*t,255)}, ${Math.max(255-3*t,0)}, 50)`),this.ctx.fillRect(this.width-35,this.height-5-5*t,30,-3)}drawTexts(t){this.setFillStyle("#FFFFFF"),this.ctx.fillText(`AVERAGE_COLOR: ${t}`,10,50),this.ctx.fillText(`CURR_TIME: ${(new Date).getTime()}`,10,75),this.ctx.fillText(`T_4_HUMAN: ${(new Date).toDateString()}`,10,100)}drawAvarageColorRect(t){this.ctx.fillStyle=t,this.ctx.fillRect(10,140,320,30),this.ctx.strokeStyle="#fff",this.ctx.strokeRect(10,140,320,30)}animate(){const t=this.scene.getRGB(),e=this.rgbToHex(t.r,t.g,t.b);this.clearCanvas(),this.drawHistogramm(),this.drawTexts(e),this.drawAvarageColorRect(e),this.scene.getDetected()&&this.drawDetected(),this.scene.detectMove(),requestAnimationFrame(this.animate.bind(this))}}(h,d,l).connectScene(g).then(t=>t.animate()),c.addEventListener("click",()=>{g.toggleMuteSpeech()})}]);